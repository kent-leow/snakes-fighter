name: Complete CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  FLUTTER_VERSION: '3.32.8'

jobs:
  # Quality Gates
  code-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Check formatting
        run: dart format --page-width=80 --output=none --set-exit-if-changed .

      - name: Create Firebase options file
        run: |
          cp lib/firebase_options.dart.example lib/firebase_options.dart
          dart format --page-width=80 lib/firebase_options.dart

      - name: Analyze code
        run: flutter analyze --fatal-infos

      - name: Check import sorting
        run: dart run import_sorter:main --no-comments --exit-if-changed

  # Security Checks
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security audit
        run: |
          echo "ðŸ” Scanning for security vulnerabilities..."
          grep -r "TODO.*security\|FIXME.*security\|password\|secret\|token" lib/ || echo "No obvious security issues found"

      - name: Check Firebase rules
        run: |
          if [ -f "database.rules.json" ]; then
            echo "âœ… Firebase database rules found"
            cat database.rules.json | jq . > /dev/null || echo "âš ï¸  Invalid JSON in database rules"
          fi

  # Testing
  test:
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan]
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Create Firebase options file
        run: |
          cp lib/firebase_options.dart.example lib/firebase_options.dart
          dart format --page-width=80 lib/firebase_options.dart

      - name: Get dependencies
        run: flutter pub get

      - name: Run unit tests
        run: flutter test --exclude-tags firebase --coverage --reporter=github

      - name: Run integration tests
        run: flutter test integration_test/ || echo "Integration tests skipped"

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: coverage/lcov.info
          fail_ci_if_error: false

  # Build and deploy to development
  build-dev:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Create Firebase options file
        run: |
          cp lib/firebase_options.dart.example lib/firebase_options.dart
          dart format --page-width=80 lib/firebase_options.dart

      - name: Get dependencies
        run: flutter pub get

      - name: Build web application
        run: |
          flutter build web --release \
            --tree-shake-icons \
            --dart-define=ENVIRONMENT=development \
            --dart-define=FIREBASE_PROJECT_ID=snakes-fight-dev

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}'
          channelId: live
          projectId: snakes-fight-dev

  # Mobile builds on release
  build-mobile-release:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'release'
    timeout-minutes: 45
    steps:
      - name: Trigger mobile build workflow
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-mobile.yml',
              ref: 'main',
              inputs: {
                version: context.payload.release.tag_name.replace('v', ''),
                build_number: context.run_number.toString()
              }
            })

  # Performance monitoring
  performance-check:
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Create Firebase options file
        run: |
          cp lib/firebase_options.dart.example lib/firebase_options.dart
          dart format --page-width=80 lib/firebase_options.dart

      - name: Get dependencies
        run: flutter pub get

      - name: Build web for performance analysis
        run: |
          flutter build web --release \
            --dart-define=ENVIRONMENT=development \
            --tree-shake-icons

      - name: Analyze bundle size
        run: |
          WEB_SIZE=$(du -sh build/web | cut -f1)
          echo "Web build size: $WEB_SIZE"
          
          # Check if build is under 30MB (reasonable for Flutter web with CanvasKit)
          # Convert size to KB for comparison (works across platforms)
          SIZE_KB=$(du -sk build/web | cut -f1)
          MAX_SIZE_KB=$((30 * 1024))  # 30MB in KB
          
          if [ $SIZE_KB -gt $MAX_SIZE_KB ]; then
            echo "âš ï¸  Build size ($WEB_SIZE) exceeds 30MB limit"
            exit 1
          else
            echo "âœ… Build size within limits"
          fi
          
          # Report component sizes for monitoring
          CANVASKIT_SIZE=$(du -sh build/web/canvaskit 2>/dev/null | cut -f1 || echo "N/A")
          MAIN_JS_SIZE=$(du -sh build/web/main.dart.js 2>/dev/null | cut -f1 || echo "N/A")
          ASSETS_SIZE=$(du -sh build/web/assets 2>/dev/null | cut -f1 || echo "N/A")
          
          echo "ðŸ“Š Bundle composition:"
          echo "  CanvasKit: $CANVASKIT_SIZE"
          echo "  Main JS: $MAIN_JS_SIZE"
          echo "  Assets: $ASSETS_SIZE"
          
          # Performance recommendations
          echo ""
          echo "ðŸ’¡ Performance notes:"
          echo "  - CanvasKit provides high-performance graphics rendering"
          echo "  - Use 'flutter build web --web-renderer html' for smaller bundle (lower performance)"
          echo "  - Current configuration prioritizes performance over size"

  # Deployment status
  deployment-status:
    runs-on: ubuntu-latest
    needs: [build-dev, build-mobile-release]
    if: always()
    steps:
      - name: Report deployment status
        run: |
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-dev.result }}" == "success" ]; then
            echo "| Development | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-dev.result }}" == "skipped" ]; then
            echo "| Development | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Development | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build-mobile-release.result }}" == "success" ]; then
            echo "| Mobile Apps | âœ… Building |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-mobile-release.result }}" == "skipped" ]; then
            echo "| Mobile Apps | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Mobile Apps | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
